// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountType {
  EVERYDAY
  CORPORATE
}

enum BusinessType {
  BUSINESS_OWNER
  TRUST_OWNER
  EMPLOYEE
}

enum PlanType {
  BASIC
  STANDARD
  PREMIUM
}

// For internal use case
enum Role {
  CUSTOMER
  DEVELOPER
  TESTING
  MANAGER
}

// KYC related enums
enum KYCStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  RESUBMIT_REQUIRED
}

enum KYCSection {
  PERSONAL_DETAILS
  CONTACT_DETAILS
  SOURCE_OF_FUNDS
  PRIMARY_DOCUMENT
  SECONDARY_DOCUMENT
  BIOMETRICS
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  SEPARATED
  COMMON_LAW
}

enum VisaStatus {
  AUSTRALIAN_CITIZEN
  PERMANENT_RESIDENT
  TEMPORARY_VISA
  STUDENT_VISA
  WORK_VISA
  REFUGEE_VISA
  OTHER
}

enum DocumentType {
  DRIVERS_LICENCE
  PASSPORT
  NATIONAL_ID
  BIRTH_CERTIFICATE
  PROOF_OF_AGE_CARD
  BANK_STATEMENT
  UTILITY_BILL
  GOVERNMENT_LETTER
  OTHER
}

enum IncomeRange {
  BELOW_30K
  FROM_30K_TO_50K
  FROM_50K_TO_80K
  FROM_80K_TO_120K
  FROM_120K_TO_200K
  ABOVE_200K
}

enum IncomeSource {
  SALARY
  BUSINESS
  INVESTMENT
  PENSION
  RENTAL
  GOVERNMENT_BENEFITS
  OTHER
}

enum VerificationProvider {
  PROVIDER_A
  PROVIDER_B
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  ERROR
}

enum RejectionReason {
  DOCUMENT_EXPIRED
  DOCUMENT_UNCLEAR
  INFORMATION_MISMATCH
  FRAUD_SUSPECTED
  INCOMPLETE_INFORMATION
  FAILED_BIOMETRIC_CHECK
  FAILED_THIRD_PARTY_VERIFICATION
  OTHER
}

enum AddressType {
  BILLING
  SHIPPING
  RESIDENTIAL
  BUSINESS
}

model devices {
  id                String    @id @default(cuid())
  customerId        String?
  deviceName        String?
  deviceType        String? // "mobile" | "tablet" | "desktop"
  os                String?
  osVersion         String?
  deviceFingerprint String?
  ip                String?
  isActive          Boolean   @default(true)
  lastUsedAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  customer customers?      @relation(fields: [customerId], references: [id])
  events   device_events[]

  registrationTokens   registration_tokens[]
  registrationAttempts registration_attempts[]
  blocks               blocks[]
  smsEvents            sms_events[]

  @@index([customerId])
  @@index([deviceFingerprint])
  @@index([ip])
  @@index([isActive])
}

model device_events {
  id        String   @id @default(cuid())
  deviceId  String
  eventType String
  eventMeta Json?
  createdAt DateTime @default(now())

  device devices @relation(fields: [deviceId], references: [id])

  @@index([deviceId])
  @@index([eventType])
  @@index([createdAt])
}

model customers {
  id            String   @id @default(cuid())
  email         String   @unique
  emailVerified Boolean  @default(false)
  phone         String?  @unique
  phoneVerified Boolean  @default(false)
  firstName     String?
  lastName      String?
  username      String?
  passwordHash  String // bcrypt / argon2 hash
  imageUrl      String?
  isActive      Boolean  @default(false)
  role          Role     @default(CUSTOMER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  accounts       accounts?
  devices        devices[]
  kycSubmissions kyc_submissions[]

  @@index([emailVerified])
  @@index([phoneVerified])
  @@index([createdAt])
}

model registration_tokens {
  id                String    @id @default(cuid())
  email             String?
  phone             String?
  firstName         String?
  lastName          String?
  token             String // 6-digit code (store as string), hashed version recommended
  tokenHash         String? // (optional) hashed token if you don't want to store plain token
  tokenType         String    @default("sms") // sms / email
  ip                String? // inet string
  deviceFingerprint String? // device fingerprint hash
  attempts          Int       @default(0) // how many times user tried to validate this token
  maxAttempts       Int       @default(5) // configurable
  createdAt         DateTime  @default(now())
  expiresAt         DateTime // e.g., now() + interval '10 minutes'
  verifiedAt        DateTime?
  verifiedByUserId  String? // customers.id when verified (optional)
  status            String    @default("pending") // pending / verified / expired / blocked
  meta              Json?
  devices           devices?  @relation(fields: [devicesId], references: [id])
  devicesId         String?

  @@unique([email, token]) // optional uniqueness to avoid dup tokens for same phone
  @@index([phone])
  @@index([email])
  @@index([ip])
  @@index([deviceFingerprint])
  @@index([expiresAt])
  @@index([status])
}

model registration_attempts {
  id        String   @id @default(cuid())
  phone     String?
  email     String?
  ip        String?
  deviceId  String?
  action    String // "created_token", "validated_token", "resent_sms"
  result    String // "success" / "fail" / "blocked"
  reason    String? // "invalid_token", "rate_limited", "blocked_ip", "sms_failed"
  createdAt DateTime @default(now())
  devices   devices? @relation(fields: [devicesId], references: [id])
  devicesId String?

  @@index([phone])
  @@index([email])
  @@index([ip])
  @@index([createdAt])
}

model sms_events {
  id         String   @id @default(cuid())
  phone      String
  direction  String   @default("outbound") // outbound / inbound
  provider   String? // e.g., "twilio"
  providerId String? // provider message id
  status     String // sent / delivered / failed / queued
  statusCode String?
  message    String? // optional message body summary
  meta       Json?
  createdAt  DateTime @default(now())
  devices    devices? @relation(fields: [devicesId], references: [id])
  devicesId  String?

  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

model blocks {
  id        String    @id @default(cuid())
  scope     String // "ip" | "phone" | "email" | "device"
  value     String // the ip / phone / email / device fingerprint
  reason    String?
  source    String? // "auto-rule" | "admin" | "threat-feed"
  createdAt DateTime  @default(now())
  expiresAt DateTime? // null = permanent
  active    Boolean   @default(true)
  meta      Json?
  devices   devices?  @relation(fields: [devicesId], references: [id])
  devicesId String?

  @@unique([scope, value])
  @@index([scope, value])
  @@index([active])
  @@index([expiresAt])
}

model addresses {
  id        String @id @default(cuid())
  accountId String

  type      AddressType @default(BILLING)
  isDefault Boolean     @default(false)

  // Address fields
  streetAddress  String
  streetAddress2 String? // Apartment, suite, unit number, etc.
  city           String
  state          String
  postalCode     String
  country        String  @default("AU")

  // Metadata
  label     String? // e.g., "Home", "Office", "Main Card"
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  account accounts @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([type])
  @@index([isDefault])
}

// KYC Submissions - Main KYC data table
model kyc_submissions {
  id         String @id @default(cuid())
  customerId String

  // Status tracking
  status            KYCStatus        @default(IN_PROGRESS)
  submittedAt       DateTime?
  reviewedAt        DateTime?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  rejectionReason   RejectionReason?
  rejectionDetails  String?
  completedSections KYCSection[]

  // Personal Details
  title         String?
  firstName     String
  middleName    String?
  lastName      String
  dateOfBirth   DateTime
  gender        Gender?
  maritalStatus MaritalStatus?
  visaStatus    VisaStatus?

  // Contact Details
  email         String
  phone         String
  streetAddress String?
  city          String?
  state         String?
  postalCode    String?
  country       String?

  // Source of Funds
  occupation           String?
  industryType         String?
  annualIncome         IncomeRange?
  incomeSources        IncomeSource[] // Array type
  activities           String[] // Activity types
  transactionCountries String[] // Transaction country codes

  // Biometrics
  biometricConsentGiven Boolean   @default(false)
  biometricConsentAt    DateTime?

  // Metadata
  submissionData Json? // Stores complete frontend JSON as backup
  internalNotes  String? // Internal review notes
  lastUpdated    DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  customer      customers           @relation(fields: [customerId], references: [id])
  documents     kyc_documents[]
  verifications kyc_verifications[]

  @@index([customerId])
  @@index([status])
  @@index([submittedAt])
  @@index([approvedAt])
}

// KYC Documents - Stores all uploaded documents
model kyc_documents {
  id           String @id @default(cuid())
  submissionId String

  // Document Classification
  documentType    DocumentType
  documentPurpose String // "primary_id", "secondary_id", "proof_of_address", "selfie"

  // Document Details
  documentNumber String?
  issuingCountry String?
  expiryDate     DateTime?

  // File Storage (S3)
  s3Key        String // S3 object key
  s3Bucket     String? // S3 bucket name
  fileUrl      String // URL used by frontend (can be pre-signed URL)
  originalPath String? // Original upload path (from frontend)
  fileName     String?
  fileSize     Int? // bytes
  mimeType     String?

  // Image specific (for photos with front/back)
  imageSide String? // "front", "back", null for single-sided

  // Metadata
  uploadedAt        DateTime  @default(now())
  processedAt       DateTime? // Document processing completion time
  verified          Boolean   @default(false)
  verifiedAt        DateTime?
  additionalDetails Json? // Stores additional document details

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  submission kyc_submissions @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([documentType])
  @@index([documentPurpose])
  @@index([verified])
}

// KYC Verifications - Third-party verification results
model kyc_verifications {
  id           String @id @default(cuid())
  submissionId String

  // Provider Info
  provider          VerificationProvider
  providerSessionId String? // Third-party session/transaction ID

  // Verification Details
  verificationType String // "identity", "document", "biometric", "address"
  status           VerificationStatus @default(PENDING)
  score            Float? // Confidence score (0-100)

  // Results
  checksPassed    String[] // Passed checks
  checksFailed    String[] // Failed checks
  matchPercentage Float? // Match percentage

  // Response Data
  requestPayload Json? // Data sent to third-party
  responseData   Json? // Complete response from third-party
  errorMessage   String?

  // Timestamps
  requestedAt DateTime  @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  submission kyc_submissions @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([provider])
  @@index([status])
  @@index([verificationType])
}

model accounts {
  id         String @id @default(cuid())
  customerId String @unique // 1-to-1 with customers

  accountType AccountType @default(EVERYDAY)

  businessType BusinessType?

  // KYC fields
  isKYCVerified       Boolean   @default(false)
  kycStatus           KYCStatus @default(NOT_STARTED)
  kycVerifiedAt       DateTime?
  kycRejectedAt       DateTime?
  currentSubmissionId String?
  kycLevel            Int       @default(0) // 0=unverified, 1=basic, 2=fully_verified

  // Account-level documents (non-KYC)
  profileImageUrl   String? // User profile image S3 URL
  profileImageS3Key String? // S3 key for profile image
  companyLogoUrl    String? // Company logo (for corporate accounts)
  companyLogoS3Key  String? // S3 key for company logo

  planId        String?
  plan          PlanType @default(BASIC)
  planUpdatedAt DateTime @default(now())
  planStartAt   DateTime @default(now())

  planEndAt  DateTime?
  renewAt    DateTime?
  canceledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  customer  customers   @relation(fields: [customerId], references: [id])
  addresses addresses[]

  @@index([accountType])
  @@index([businessType])
  @@index([isKYCVerified])
  @@index([kycStatus])
}
